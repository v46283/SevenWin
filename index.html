<!-- File: Index.html -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>行口雲端對賬系統</title>
<style>
body{font-family:"Noto Sans TC",sans-serif;margin:20px;background:#f5f5f5;color:#333}
#loginMsg{color:red}
input,select,button{font-size:16px;padding:6px;margin:4px 0}
section{margin-bottom:20px;padding:10px;background:#fff;border-radius:6px}
.hidden{display:none}
</style>
</head>
<body>
<h1>行口雲端對賬系統</h1>
<div id="loginMsg">登入中…</div>
<section id="formSec" class="hidden">
  <h2 id="bankName"></h2>
  <label>日期 <input type="date" id="date"></label><br>
  <label>品名 <input list="prodList" id="product"></label>
  <datalist id="prodList"></datalist><br>
  <label>G台斤 <input type="number" id="g"></label><br>
  <label>J數量/籠或隻 <input type="number" id="j"></label><br>
  <label>單價 <input type="number" id="price"></label><br>
  <label>門市/去向 <input id="store"></label><br>
  <label>批次 <input id="batch"></label><br>
  <label>備註 <input id="note"></label><br>
  <button id="submitBtn">送出</button>
  <span id="msg"></span>
</section>
<section id="reportSec" class="hidden">
  <h2>報表</h2>
  <label>起 <input type="date" id="s"></label>
  <label>訖 <input type="date" id="e"></label>
  <button id="reportBtn">產出報表</button>
  <div id="report"></div>
</section>
<script>
let ctx=null;let meta=null;
function init(){
  google.script.run.withSuccessHandler(r=>{ctx=r; if(!ctx.bank){document.getElementById('loginMsg').textContent='非白名單使用者';return;} document.getElementById('loginMsg').classList.add('hidden'); document.getElementById('formSec').classList.remove('hidden'); document.getElementById('reportSec').classList.remove('hidden');document.getElementById('bankName').textContent='我的行口：'+ctx.bank; google.script.run.withSuccessHandler(m=>{meta=m;const dl=document.getElementById('prodList');m.products.forEach(p=>{const o=document.createElement('option');o.value=p[1];dl.appendChild(o);});}).loadMeta();}).getUserContext();
}
document.getElementById('submitBtn').onclick=function(){const rec={date:date.value,product:product.value,g:g.value,j:j.value,price:price.value,store:store.value,batch:batch.value,note:note.value,bank:ctx.bank};google.script.run.withSuccessHandler(res=>{if(res.status==='PASS'){msg.textContent='已寫入';}else{msg.textContent=res.message||res.status;}}).submitRaw(rec);};
document.getElementById('reportBtn').onclick=function(){const s=new Date(document.getElementById('s').value);const e=new Date(document.getElementById('e').value);google.script.run.withSuccessHandler(html=>{document.getElementById('report').innerHTML=html;}).showReport(s,e);};
window.addEventListener('load',init);
</script>
</body>
</html>
