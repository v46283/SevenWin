<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>行口雲端對賬系統</title>
<style>
body{font-family:"Noto Sans TC",sans-serif;margin:20px;background:#f5f5f5;color:#333;}
input,select,button{font-size:16px;padding:8px;margin:4px 0;}
.hidden{display:none;}
.warn{color:#c00;}
</style>
</head>
<body>
<h1 id="title">行口雲端對賬系統</h1>
<div id="upload" class="hidden">
  <h2>上傳入口</h2>
  <form id="formUpload">
    <label>日期 <input type="date" id="uDate" required></label><br>
    <label>品名 <input type="text" id="uItem" required></label><br>
    <label>G台斤 <input type="number" id="uWeight" step="0.01"></label><br>
    <label>J數量 <input type="number" id="uQty" step="1"></label><br>
    <label>單價 <input type="number" id="uPrice" step="0.01"></label><br>
    <label>門市/去向 <input type="text" id="uDest"></label><br>
    <label>批次 <input type="text" id="uBatch"></label><br>
    <label>備註 <input type="text" id="uNote"></label><br>
    <button type="button" id="btnCheck">查重</button>
    <button type="submit">送出</button>
    <div id="uMsg"></div>
  </form>
</div>
<div id="query" class="hidden">
  <h2>查詢入口</h2>
  <label>起日 <input type="date" id="qStart"></label>
  <label>迄日 <input type="date" id="qEnd"></label>
  <button id="btnReport">產生報表</button>
  <pre id="qResult"></pre>
</div>
<div id="admin" class="hidden">
  <h2>管理者入口</h2>
  <button id="btnCloseMonth">封存本月</button>
  <div id="aMsg"></div>
</div>
<script>
const token = new URLSearchParams(location.search).get('token');
let scope='',bank='',entryId='';
function $(id){return document.getElementById(id);}
async function api(action, method='GET', data){
  let url = '?token=' + encodeURIComponent(token) + '&action=' + action;
  const opt = {method:method};
  if(method==='POST'){
    opt.headers={'Content-Type':'application/json'};
    opt.body = JSON.stringify(data||{});
  }else if(data){
    url += '&' + new URLSearchParams(data).toString();
  }
  const res = await fetch(url,opt);
  return res.json();
}
async function init(){
  if(!token){$('title').textContent='缺少 token';return;}
  const info = await api('tokenInfo');
  if(info.error){$('title').textContent=info.error;return;}
  scope=info.scope; bank=info.bank; entryId=info.entryId;
  $('title').textContent=bank+' | '+info.scopeText;
  if(scope==='upload') $('upload').classList.remove('hidden');
  if(scope==='query') $('query').classList.remove('hidden');
  if(scope==='admin') $('admin').classList.remove('hidden');
}
$('formUpload').addEventListener('submit', async e=>{
  e.preventDefault();
  const data={date:$('uDate').value,item:$('uItem').value,weight:$('uWeight').value,qty:$('uQty').value,price:$('uPrice').value,dest:$('uDest').value,batch:$('uBatch').value,note:$('uNote').value};
  const res=await api('upload','POST',data);
  $('uMsg').textContent=res.message||JSON.stringify(res);
  $('uMsg').className = res.status==='OK'?'':'warn';
});
$('btnCheck').onclick=async()=>{
  const data={date:$('uDate').value,item:$('uItem').value,weight:$('uWeight').value,qty:$('uQty').value,price:$('uPrice').value,batch:$('uBatch').value};
  const res=await api('check','POST',data);
  $('uMsg').textContent=res.message;
  $('uMsg').className=res.duplicate?'warn':'';
};
$('btnReport').onclick=async()=>{
  const res=await api('report','GET',{start:$('qStart').value,end:$('qEnd').value});
  $('qResult').textContent=JSON.stringify(res,null,2);
};
$('btnCloseMonth').onclick=async()=>{
  const res=await api('closeMonth','POST',{});
  $('aMsg').textContent=res.message;
};
init();
</script>
</body>
</html>
